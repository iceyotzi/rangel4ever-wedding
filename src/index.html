<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RANGEL4EVER</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="./assets/favicon.png">
    <link rel="apple-touch-icon" href="./assets/favicon.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&family=Lora:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://docs.google.com">
    <link rel="dns-prefetch" href="https://docs.google.com">
    <link href="./css/output.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-apricot-900 to-melon-900 min-h-screen font-body">
    <!-- Navigation Bar -->
    <nav class="bg-white shadow-lg fixed w-full top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <a href="#home" class="text-2xl font-bold text-redwood font-heading">RANGEL4EVER</a>
                <div class="hidden md:flex space-x-8">
                    <a href="#home" class="text-chocolate_cosmos-500 hover:text-redwood transition-colors font-semibold">Home</a>
                    <a href="#schedule" class="text-chocolate_cosmos-500 hover:text-redwood transition-colors font-semibold">Schedule</a>
                    <a href="#visitor-guides" class="text-chocolate_cosmos-500 hover:text-redwood transition-colors font-semibold">Visitor Guides</a>
                    <a href="#our-story" class="text-chocolate_cosmos-500 hover:text-redwood transition-colors font-semibold">Our Story</a>
                    <a href="https://www.amazon.com/wedding/guest-view/90A2KOA2YAH0" target="_blank" rel="noopener noreferrer" class="text-chocolate_cosmos-500 hover:text-redwood transition-colors font-semibold">Registry</a>
                    <a href="#faq" class="text-chocolate_cosmos-500 hover:text-redwood transition-colors font-semibold">FAQ</a>
                </div>
                <!-- Mobile menu button -->
                <button class="md:hidden text-chocolate_cosmos-500" onclick="toggleMenu()">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
            <!-- Mobile menu -->
            <div id="mobile-menu" class="hidden md:hidden pb-4">
                <a href="#home" class="block py-2 text-chocolate_cosmos-500 hover:text-redwood font-semibold">Home</a>
                <a href="#schedule" class="block py-2 text-chocolate_cosmos-500 hover:text-redwood font-semibold">Schedule</a>
                <a href="#visitor-guides" class="block py-2 text-chocolate_cosmos-500 hover:text-redwood font-semibold">Visitor Guides</a>
                <a href="#our-story" class="block py-2 text-chocolate_cosmos-500 hover:text-redwood font-semibold">Our Story</a>
                <a href="https://www.amazon.com/wedding/guest-view/90A2KOA2YAH0" class="block py-2 text-chocolate_cosmos-500 hover:text-redwood font-semibold">Registry</a>
                <a href="#faq" class="block py-2 text-chocolate_cosmos-500 hover:text-redwood font-semibold">FAQ</a>
            </div>
        </div>
    </nav>

    <!-- Hero Video Section -->
    <section id="home" class="relative pt-16 overflow-hidden">
        <!-- Video Container -->
        <div class="relative w-full h-screen max-h-[600px] md:max-h-[700px]">
            <!-- Background Video -->
            <video 
                class="absolute top-0 left-0 w-full h-full object-cover"
                autoplay 
                loop 
                muted 
                playsinline>
                <!-- Option 1: Self-hosted video (recommended for GitHub Pages) -->
                <source src="./assets/hero-video.mp4" type="video/mp4">
                <source src="./assets/hero-video.webm" type="video/webm">
                
                <!-- Fallback for browsers that don't support video -->
                Your browser does not support the video tag.
            </video>
            
            <!-- Dark Overlay for better text readability -->
            <!-- <div class="absolute top-0 left-0 w-full h-full bg-black bg-opacity-40"></div> -->
            
            <!-- Text Content Overlay
            <div class="relative z-10 flex flex-col items-center justify-center h-full px-4 text-center">
                <h1 class="text-5xl md:text-7xl font-bold text-white mb-6 font-heading drop-shadow-lg">
                    Welcome to RANGEL4EVER
                </h1>
                <p class="text-xl md:text-3xl text-white mb-8 max-w-3xl mx-auto drop-shadow-md">
                    Creating unforgettable experiences and lasting memories
                </p>
                <a href="#schedule" class="inline-block bg-redwood hover:bg-cordovan text-white font-semibold py-4 px-10 rounded-lg transition-colors shadow-xl hover:shadow-2xl transform hover:scale-105">
                    View Schedule
                </a>
            </div> -->
        </div>
    </section>

    <!-- Large Quote Section -->
    <section class="py-20 px-4 bg-cordovan">
        <div class="container mx-auto">
            <a href="https://www.youtube.com/watch?v=kl0DehwApzE" target="_blank" rel="noopener noreferrer" class="block hover:scale-105 transition-transform">
                <blockquote class="text-center">
                    <p class="text-3xl md:text-5xl font-bold text-white mb-6 leading-relaxed font-heading">
                        "I want a Sunday kind of love..."
                    </p>
                    <footer class="text-xl text-melon-800">
                        — Click to listen
                    </footer>
                </blockquote>
            </a>
        </div>
    </section>

    <!-- Schedule Section -->
    <section id="schedule" class="py-20 px-4">
        <div class="container mx-auto max-w-4xl">
            <h2 class="text-4xl font-bold text-chocolate_cosmos text-center mb-12 font-heading">Schedule</h2>
            
            <!-- Loading State -->
            <div id="schedule-loading" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-redwood"></div>
                <p class="mt-4 text-cordovan-400">Loading schedule...</p>
            </div>
            
            <!-- Error State -->
            <div id="schedule-error" class="hidden bg-melon-900 border-l-4 border-redwood rounded-lg p-6">
                <h3 class="text-xl font-semibold text-chocolate_cosmos mb-2 font-heading">Unable to Load Schedule</h3>
                <p class="text-cordovan-400 mb-4">We're having trouble loading the schedule. Please try refreshing the page.</p>
                <button onclick="loadSchedule()" class="bg-redwood hover:bg-cordovan text-white font-semibold py-2 px-6 rounded-lg transition-colors">
                    Try Again
                </button>
            </div>
            
            <!-- Schedule Container (populated by JavaScript) -->
            <div id="schedule-container" class="space-y-6 hidden">
                <!-- Events will be inserted here dynamically -->
            </div>
        </div>
    </section>

    <!-- Visitor Guides Section -->
    <section id="visitor-guides" class="py-20 px-4 bg-white">
        <div class="container mx-auto max-w-6xl">
            <h2 class="text-4xl font-bold text-chocolate_cosmos text-center mb-12 font-heading">Visitor Guides</h2>
            <div class="grid md:grid-cols-3 gap-8">
                <div class="bg-gradient-to-br from-apricot-800 to-melon-800 rounded-lg shadow-lg p-8">
                    <div class="text-redwood mb-4">
                        <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-semibold text-chocolate_cosmos mb-3 font-heading">Must See</h3>
                    <p class="text-cordovan-400 mb-4">
                        SF has something to offer for everybody! Check out the map below for some of our favorite spots.
                        Some ideas to get you started!
                    </p>
                    <ul class="space-y-2 text-chocolate_cosmos-400">
                        <li>• Bike across the Golden Gate Bridge</li>
                        <li>• Ride on a cable car</li>
                        <li>• Eat... SF is still the food capital of the world</li>
                    </ul>
                </div>

                <div class="bg-gradient-to-br from-apricot-800 to-melon-800 rounded-lg shadow-lg p-8">
                    <div class="text-redwood mb-4">
                        <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-semibold text-chocolate_cosmos mb-3 font-heading">Contacts</h3>
                    <p class="text-cordovan-400 mb-4">
                        Feel free to reach out to us if you have any questions or concerns! Find our contact information on the partiful invite. Click <a href="https://partiful.com/e/mESIcwYs2fG6i5dpup8F" target="_blank" rel="noopener noreferrer" class="text-redwood hover:text-cordovan underline font-semibold">here</a> to view the invite.
                    </p>
                    <!-- <ul class="space-y-2 text-chocolate_cosmos-400">
                        <li>• <a href="https://partiful.com/e/mESIcwYs2fG6i5dpup8F">partiful invite</a></li>
                        <li>• 415-555-5555</li>
                        <li>• 123 Main St, San Francisco, CA 94133</li>
                    </ul> -->
                </div>

                <div class="bg-gradient-to-br from-apricot-800 to-melon-800 rounded-lg shadow-lg p-8">
                    <div class="text-redwood mb-4">
                        <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-semibold text-chocolate_cosmos mb-3 font-heading">Things to Know</h3>
                    <p class="text-cordovan-400 mb-4">
                        Insider information to make your visit more enjoyable.
                    </p>
                    <ul class="space-y-2 text-chocolate_cosmos-400">
                        <li>• Bring a jacket! Chances are SF is chillier than you think. </li>
                        <li>• Use transit! You can get a transit card (search for Clipper Card) directly on your phone.</li>
                        <!-- <li>• Feel free to reach out to us if you have any questions or concerns!</li> -->
                    </ul>
                </div>
            </div>
            
            <!-- Interactive Map Section -->
            <div class="mt-16">
                <h3 class="text-3xl font-bold text-chocolate_cosmos text-center mb-8 font-heading">Interactive Map</h3>
                
                <!-- Embedded Map -->
                <div class="bg-white rounded-lg shadow-xl overflow-hidden">
                    <iframe 
                        id="visitor-map"
                        src="https://www.google.com/maps/d/embed?mid=1guPH1XzRA9GwbAvSLlIwYMJ6xO8tDC8&ll=37.78664500022318,-122.41515163739476&z=13"
                        width="100%" 
                        height="600" 
                        style="border:0;" 
                        allowfullscreen="" 
                        loading="lazy" 
                        referrerpolicy="no-referrer-when-downgrade">
                    </iframe>
                </div>
                
                <p class="text-center text-chocolate_cosmos-400 mt-4 text-sm">
                    💡 Click markers on the map for more information. Use the layer menu (☰) on the map to show/hide different categories.
                </p>
            </div>
        </div>
    </section>

    <!-- Our Story Section -->
    <section id="our-story" class="py-20 px-4 overflow-hidden">
        <div class="container mx-auto max-w-6xl">
            <h2 class="text-4xl font-bold text-chocolate_cosmos text-center mb-12 font-heading">Our Story</h2>
            
            <!-- Loading State -->
            <div id="story-loading" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-redwood"></div>
                <p class="mt-4 text-cordovan-400">Loading our story...</p>
            </div>
            
            <!-- Error State -->
            <div id="story-error" class="hidden bg-melon-900 border-l-4 border-redwood rounded-lg p-6 max-w-4xl mx-auto">
                <h3 class="text-xl font-semibold text-chocolate_cosmos mb-2 font-heading">Unable to Load Story</h3>
                <p class="text-cordovan-400 mb-4">We're having trouble loading our story. Please try refreshing the page.</p>
                <button onclick="loadStory()" class="bg-redwood hover:bg-cordovan text-white font-semibold py-2 px-6 rounded-lg transition-colors">
                    Try Again
                </button>
            </div>
            
            <!-- Horizontal Gallery -->
            <div id="story-gallery" class="hidden">
                <div class="flex overflow-x-auto gap-6 pb-6 snap-x snap-mandatory scrollbar-hide" style="scroll-behavior: smooth; -webkit-overflow-scrolling: touch; min-height: 440px;">
                    <!-- Story items will be inserted here dynamically -->
                </div>
                
                <!-- Navigation Dots -->
                <div id="story-dots" class="flex justify-center gap-2 mt-6">
                    <!-- Dots will be inserted here dynamically -->
                </div>
            </div>
        </div>
    </section>

    <!-- Wedding Registry Section -->
    <section id="registry" class="py-20 px-4 bg-cordovan">
        <div class="container mx-auto">
            <a href="https://www.amazon.com/wedding/guest-view/90A2KOA2YAH0" target="_blank" rel="noopener noreferrer" class="block hover:scale-105 transition-transform">
                <div class="text-center">
                    <!-- Gift Icon -->
                    <div class="mb-6 flex justify-center">
                        <svg class="w-20 h-20 text-melon-800" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"></path>
                        </svg>
                    </div>
                    <blockquote>
                        <p class="text-3xl md:text-5xl font-bold text-white mb-6 leading-relaxed font-heading">
                            Your presence is the best gift... but the second best can be found on our registry. 😂
                        </p>
                        <footer class="text-xl text-melon-800">
                            — Click to view our registry
                        </footer>
                    </blockquote>
                </div>
            </a>
        </div>
    </section>

    <!-- FAQ Section -->
    <section id="faq" class="py-20 px-4 bg-white">
        <div class="container mx-auto max-w-4xl">
            <h2 class="text-4xl font-bold text-chocolate_cosmos text-center mb-12 font-heading">Frequently Asked Questions</h2>
            
            <!-- Loading State -->
            <div id="faq-loading" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-redwood"></div>
                <p class="mt-4 text-cordovan-400">Loading FAQs...</p>
            </div>
            
            <!-- Error State -->
            <div id="faq-error" class="hidden bg-melon-900 border-l-4 border-redwood rounded-lg p-6">
                <h3 class="text-xl font-semibold text-chocolate_cosmos mb-2 font-heading">Unable to Load FAQs</h3>
                <p class="text-cordovan-400 mb-4">We're having trouble loading the FAQs. Please try refreshing the page.</p>
                <button onclick="loadFAQs()" class="bg-redwood hover:bg-cordovan text-white font-semibold py-2 px-6 rounded-lg transition-colors">
                    Try Again
                </button>
            </div>
            
            <!-- FAQ Container (populated by JavaScript) -->
            <div id="faq-container" class="space-y-6 hidden">
                <!-- FAQs will be inserted here dynamically -->
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-chocolate_cosmos text-white py-12 px-4">
        <div class="container mx-auto text-center">
            <h3 class="text-2xl font-bold mb-4 font-heading">RANGEL4EVER</h3>
            <p class="text-melon-700 mb-6">Making memories since 2022</p>
            <div class="flex justify-center space-x-6 mb-6">
                <a href="#home" class="text-melon-700 hover:text-melon transition-colors font-semibold">Home</a>
                <a href="#schedule" class="text-melon-700 hover:text-melon transition-colors font-semibold">Schedule</a>
                <a href="#visitor-guides" class="text-melon-700 hover:text-melon transition-colors font-semibold">Guides</a>
                <a href="#our-story" class="text-melon-700 hover:text-melon transition-colors font-semibold">Story</a>
                <a href="https://www.amazon.com/wedding/guest-view/90A2KOA2YAH0" target="_blank" rel="noopener noreferrer" class="text-melon-700 hover:text-melon transition-colors font-semibold">Registry</a>
                <a href="#faq" class="text-melon-700 hover:text-melon transition-colors font-semibold">FAQ</a>
            </div>
            <p class="text-melon-800">&copy; 2025 RANGEL4EVER</p>
        </div>
    </footer>

    <script>
        // Mobile menu toggle
        function toggleMenu() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        }
        
        // Close mobile menu when clicking a link
        document.addEventListener('DOMContentLoaded', function() {
            const mobileMenu = document.getElementById('mobile-menu');
            const mobileLinks = mobileMenu.querySelectorAll('a');
            
            mobileLinks.forEach(link => {
                link.addEventListener('click', function() {
                    // Close the menu
                    mobileMenu.classList.add('hidden');
                });
            });
        });

        // ============================================
        // GOOGLE SHEETS INTEGRATION (OPTIMIZED - CSV METHOD)
        // ============================================
        
        // Your Google Sheets CSV export URLs
        // File → Share → Publish to web → Choose specific sheet and CSV format
        // Get your Sheet ID from: https://docs.google.com/spreadsheets/d/SHEET_ID/edit
        
        // Schedule tab (first sheet or specify gid)
        const SCHEDULE_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS2oAMBT5LlO-tU1rh_APIM5SRwQ1L7aJ49D7kdjBjLJXiF6gD8ErpYVnY4oJ5nLWvazIPl-vCwNXYl/pub?output=csv';
        
        // FAQs tab (add &gid=SHEET_ID for specific tab)
        // Replace SHEET_GID with your FAQs sheet's gid number
        const FAQS_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS2oAMBT5LlO-tU1rh_APIM5SRwQ1L7aJ49D7kdjBjLJXiF6gD8ErpYVnY4oJ5nLWvazIPl-vCwNXYl/pub?gid=141987378&output=csv';
        
        // Our Story tab (add &gid=SHEET_ID for specific tab)
        // Replace SHEET_GID with your Our Story sheet's gid number
        const STORY_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS2oAMBT5LlO-tU1rh_APIM5SRwQ1L7aJ49D7kdjBjLJXiF6gD8ErpYVnY4oJ5nLWvazIPl-vCwNXYl/pub?gid=1829396289&output=csv';
        
        // Load schedule from Google Sheets (CSV method - 5-10x faster!)
        async function loadSchedule() {
            const loadingEl = document.getElementById('schedule-loading');
            const errorEl = document.getElementById('schedule-error');
            const containerEl = document.getElementById('schedule-container');
            
            loadingEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            containerEl.classList.add('hidden');
            
            try {
                // Check if URL is configured
                if (SCHEDULE_CSV_URL.includes('YOUR_SHEET_ID')) {
                    throw new Error('Google Sheets URL not configured');
                }
                
                // Fetch CSV data (200-400ms vs 2000ms with Apps Script!)
                const response = await fetch(SCHEDULE_CSV_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                console.log('📊 Schedule CSV received, length:', csvText.length);
                console.log('📄 First 500 chars:', csvText.substring(0, 500));
                
                const events = parseCSV(csvText);
                console.log('✅ Parsed events:', events);
                
                if (!events || events.length === 0) {
                    throw new Error('No events found in the schedule');
                }
                
                // Sort by order field
                events.sort((a, b) => {
                    const orderA = parseInt(a.order) || 0;
                    const orderB = parseInt(b.order) || 0;
                    return orderA - orderB;
                });
                
                // Clear and populate container
                containerEl.innerHTML = '';
                events.forEach((event, index) => {
                    console.log(`🎫 Creating event card ${index + 1}:`, event);
                    const eventCard = createEventCard(event);
                    containerEl.appendChild(eventCard);
                });
                
                loadingEl.classList.add('hidden');
                containerEl.classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading schedule:', error);
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                console.error('Error details:', {
                    message: error.message,
                    csvUrl: SCHEDULE_CSV_URL
                });
            }
        }
        
        // Load FAQs from Google Sheets
        async function loadFAQs() {
            const loadingEl = document.getElementById('faq-loading');
            const errorEl = document.getElementById('faq-error');
            const containerEl = document.getElementById('faq-container');
            
            loadingEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            containerEl.classList.add('hidden');
            
            try {
                // Check if URL is configured
                if (FAQS_CSV_URL.includes('SHEET_GID')) {
                    throw new Error('FAQs sheet GID not configured');
                }
                
                // Fetch CSV data
                const response = await fetch(FAQS_CSV_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                console.log('📊 FAQ CSV received, length:', csvText.length);
                console.log('📄 First 500 chars:', csvText.substring(0, 500));
                
                const faqs = parseCSV(csvText);
                console.log('✅ Parsed FAQs:', faqs);
                
                if (!faqs || faqs.length === 0) {
                    throw new Error('No FAQs found');
                }
                
                // Sort by id field
                faqs.sort((a, b) => {
                    const idA = parseInt(a.id) || 0;
                    const idB = parseInt(b.id) || 0;
                    return idA - idB;
                });
                
                // Clear and populate container
                containerEl.innerHTML = '';
                faqs.forEach((faq, index) => {
                    console.log(`❓ Creating FAQ card ${index + 1}:`, faq);
                    const faqCard = createFAQCard(faq);
                    containerEl.appendChild(faqCard);
                });
                
                loadingEl.classList.add('hidden');
                containerEl.classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading FAQs:', error);
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
                console.error('Error details:', {
                    message: error.message,
                    csvUrl: FAQS_CSV_URL
                });
            }
        }
        
        // Parse CSV to JSON array (handles multi-line cells)
        function parseCSV(csv) {
            console.log('🔍 parseCSV: Starting CSV parse');
            const rows = [];
            let currentRow = [];
            let currentField = '';
            let inQuotes = false;
            
            // Parse character by character to handle quoted fields with newlines
            for (let i = 0; i < csv.length; i++) {
                const char = csv[i];
                const nextChar = csv[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        // Escaped quote
                        currentField += '"';
                        i++; // Skip next quote
                    } else {
                        // Toggle quote mode
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    // End of field
                    currentRow.push(currentField);
                    currentField = '';
                } else if (char === '\n' && !inQuotes) {
                    // End of row
                    currentRow.push(currentField);
                    if (currentRow.some(field => field.trim() !== '')) {
                        rows.push(currentRow);
                    }
                    currentRow = [];
                    currentField = '';
                } else {
                    // Regular character (including newlines inside quotes)
                    currentField += char;
                }
            }
            
            // Push last field and row
            if (currentField || currentRow.length > 0) {
                currentRow.push(currentField);
                if (currentRow.some(field => field.trim() !== '')) {
                    rows.push(currentRow);
                }
            }
            
            console.log('📊 Parsed rows:', rows.length);
            console.log('📋 First row (headers):', rows[0]);
            
            if (rows.length < 2) {
                throw new Error('CSV file is empty or invalid');
            }
            
            const headers = rows[0].map(h => h.trim());
            const events = [];
            
            for (let i = 1; i < rows.length; i++) {
                const values = rows[i];
                
                if (values.length === headers.length) {
                    const event = {};
                    headers.forEach((header, index) => {
                        event[header] = values[index].trim();
                    });
                    events.push(event);
                    console.log(`📝 Row ${i}:`, event);
                }
            }
            
            return events;
        }
        
        // Parse a single CSV line (handles quoted values with commas)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    // Handle escaped quotes ("")
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++; // Skip next quote
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }
        
        // Create an event card element
        function createEventCard(event) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow overflow-hidden';
            
            const parsedDescription = parseMarkdown(event.description || '', `Event: ${event.title}`);
            
            card.innerHTML = `
                <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                    <div class="mb-4 md:mb-0 md:flex-1 md:mr-6 overflow-hidden">
                        <div class="flex items-center gap-3 mb-2 flex-wrap">
                            <h3 class="text-2xl font-semibold text-chocolate_cosmos font-heading break-words">
                                ${escapeHtml(event.title || 'Untitled Event')}
                            </h3>
                            ${event.note ? `
                                <span class="inline-block px-3 py-1 bg-redwood text-white text-sm font-semibold rounded-full whitespace-nowrap">
                                    ${escapeHtml(event.note)}
                                </span>
                            ` : ''}
                        </div>
                        <div class="text-cordovan-400 break-words overflow-wrap-anywhere">
                            ${parsedDescription}
                        </div>
                        ${event.location ? `
                            <div class="flex items-start text-redwood text-sm mt-3">
                                <svg class="w-4 h-4 mr-1 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                <span class="break-words overflow-wrap-anywhere">${parseMarkdown(event.location, 'Location: ' + event.title)}</span>
                            </div>
                        ` : ''}
                    </div>
                    <div class="text-redwood font-semibold md:text-right md:flex-shrink-0">
                        <p class="text-lg break-words">${escapeHtml(event.date || '')}</p>
                        <p class="break-words">${escapeHtml(event.time || '')}</p>
                    </div>
                </div>
            `;
            
            return card;
        }
        
        // Create a FAQ card element
        function createFAQCard(faq) {
            const card = document.createElement('div');
            card.className = 'bg-gradient-to-br from-apricot-800 to-melon-800 rounded-lg shadow-lg p-6 overflow-hidden';
            
            const parsedAnswer = parseMarkdown(faq.answer || '', `FAQ: ${faq.question}`);
            
            card.innerHTML = `
                <h3 class="text-xl font-semibold text-chocolate_cosmos mb-3 font-heading break-words">
                    ${escapeHtml(faq.question || 'Question')}
                </h3>
                <div class="text-cordovan-400 break-words overflow-wrap-anywhere">
                    ${parsedAnswer}
                </div>
            `;
            
            return card;
        }
        
        // Escape HTML to prevent XSS attacks
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Parse simple Markdown formatting (bold, italic, links, line breaks, lists)
        function parseMarkdown(text, debugLabel = '') {
            if (!text) return '';
            
            console.group(`🔍 parseMarkdown${debugLabel ? ` (${debugLabel})` : ''}`);
            console.log('📥 Input text:', text);
            console.log('📏 Length:', text.length);
            console.log('🔢 Char codes (first 100):', text.substring(0, 100).split('').map((c, i) => 
                c === '\n' ? `[LF:${text.charCodeAt(i)}]` : 
                c === '\r' ? `[CR:${text.charCodeAt(i)}]` : 
                c === '*' ? `[*:${text.charCodeAt(i)}]` : 
                c === ' ' ? `[SP]` : c
            ).join(''));
            console.log('📊 Line breaks:', {
                LF: (text.match(/\n/g) || []).length,
                CR: (text.match(/\r(?!\n)/g) || []).length,
                CRLF: (text.match(/\r\n/g) || []).length
            });
            
            // First escape HTML to prevent XSS
            let html = escapeHtml(text);
            console.log('1️⃣ After escapeHtml:', html.substring(0, 200));
            
            // Convert line breaks to <br> first (before other processing)
            html = html.replace(/\n/g, '<br>');
            console.log('2️⃣ After \\n → <br>:', html.substring(0, 200));
            
            // Convert bullet lists BEFORE italic processing (to avoid * being treated as italic)
            // Lines starting with - or * followed by space
            const beforeListConversion = html;
            html = html.replace(/<br>[\s]*[-\*]\s+/g, '<br>• ');
            console.log('3️⃣ After <br>[-*]\\s+ → <br>•:', html.substring(0, 200));
            console.log('   Matches found:', beforeListConversion !== html);
            
            // Handle first line if it starts with - or *
            const beforeFirstLine = html;
            html = html.replace(/^[\s]*[-\*]\s+/g, '• ');
            console.log('4️⃣ After ^[-*]\\s+ → •:', html.substring(0, 200));
            console.log('   First line converted:', beforeFirstLine !== html);
            
            // Convert numbered lists: lines starting with 1. 2. etc
            html = html.replace(/<br>[\s]*(\d+)\.\s+/g, '<br>$1. ');
            console.log('5️⃣ After numbered lists:', html.substring(0, 200));
            
            // Now convert **bold** to <strong>
            const boldMatches = html.match(/\*\*([^\*]+)\*\*/g);
            html = html.replace(/\*\*([^\*]+)\*\*/g, '<strong>$1</strong>');
            console.log('6️⃣ After **bold**:', html.substring(0, 200));
            console.log('   Bold matches:', boldMatches);
            
            // Convert *italic* to <em> (single asterisks not part of **)
            const italicMatches = html.match(/\*([^\*\n]+?)\*/g);
            html = html.replace(/\*([^\*\n]+?)\*/g, '<em>$1</em>');
            console.log('7️⃣ After *italic*:', html.substring(0, 200));
            console.log('   Italic matches:', italicMatches);
            
            // Convert [link text](url) to <a>
            const linkMatches = html.match(/\[([^\]]+)\]\(([^)]+)\)/g);
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer" class="text-redwood hover:text-cordovan underline font-semibold">$1</a>');
            console.log('8️⃣ After [links](url):', html.substring(0, 200));
            console.log('   Link matches:', linkMatches);
            
            console.log('✅ Final output:', html);
            console.groupEnd();
            
            return html;
        }
        
        // Load Our Story from Google Sheets
        async function loadStory() {
            const loadingEl = document.getElementById('story-loading');
            const errorEl = document.getElementById('story-error');
            const galleryEl = document.getElementById('story-gallery');
            const galleryContainer = galleryEl.querySelector('.flex');
            const dotsContainer = document.getElementById('story-dots');
            
            loadingEl.classList.remove('hidden');
            errorEl.classList.add('hidden');
            galleryEl.classList.add('hidden');
            
            try {
                // Check if URL is configured
                if (STORY_CSV_URL.includes('YOUR_STORY_GID')) {
                    throw new Error('Story sheet GID not configured');
                }
                
                // Fetch CSV data
                const response = await fetch(STORY_CSV_URL);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const csvText = await response.text();
                const storyItems = parseCSV(csvText);
                
                if (!storyItems || storyItems.length === 0) {
                    throw new Error('No story items found');
                }
                
                // Sort by id field if present
                storyItems.sort((a, b) => {
                    const idA = parseInt(a.id) || 0;
                    const idB = parseInt(b.id) || 0;
                    return idA - idB;
                });
                
                // Clear and populate gallery
                galleryContainer.innerHTML = '';
                dotsContainer.innerHTML = '';
                
                storyItems.forEach((item, index) => {
                    const storyCard = createStoryItem(item, index);
                    galleryContainer.appendChild(storyCard);
                    
                    // Create navigation dot
                    const dot = document.createElement('button');
                    dot.className = 'w-3 h-3 rounded-full bg-cordovan-400 hover:bg-redwood transition-colors';
                    dot.setAttribute('aria-label', `Go to slide ${index + 1}`);
                    dot.onclick = () => {
                        storyCard.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                    };
                    dotsContainer.appendChild(dot);
                });
                
                // Update active dot on scroll
                const updateActiveDot = () => {
                    const scrollLeft = galleryContainer.scrollLeft;
                    const itemWidth = 384 + 24; // 384px width + 24px gap
                    const activeIndex = Math.round(scrollLeft / itemWidth);
                    
                    Array.from(dotsContainer.children).forEach((dot, index) => {
                        if (index === activeIndex) {
                            dot.classList.remove('bg-cordovan-400');
                            dot.classList.add('bg-redwood');
                        } else {
                            dot.classList.remove('bg-redwood');
                            dot.classList.add('bg-cordovan-400');
                        }
                    });
                };
                
                galleryContainer.addEventListener('scroll', updateActiveDot);
                updateActiveDot(); // Set initial state
                
                loadingEl.classList.add('hidden');
                galleryEl.classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading story:', error);
                loadingEl.classList.add('hidden');
                errorEl.classList.remove('hidden');
            }
        }
        
        // Create a story item element (text or image)
        function createStoryItem(item, index) {
            const container = document.createElement('div');
            container.className = 'flex-shrink-0 snap-center';
            
            const type = (item.type || 'text').toLowerCase();
            const src = item.src || '';
            
            if (type === 'img' || type === 'image') {
                // Google Drive image
                const imageUrl = `https://drive.google.com/thumbnail?id=${src}&sz=w1000`;
                
                container.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl overflow-hidden flex items-center justify-center" style="height: 384px;">
                        <img 
                            src="${escapeHtml(imageUrl)}" 
                            alt="Our Story ${index + 1}"
                            class="h-full w-auto"
                            loading="lazy"
                        />
                    </div>
                `;
            } else {
                // Text quote
                container.innerHTML = `
                    <div class="bg-white rounded-lg shadow-xl p-8 md:p-12 flex items-center justify-center" style="width: 384px; height: 384px;">
                        <blockquote class="text-center">
                            <p class="text-2xl md:text-3xl text-chocolate_cosmos italic leading-relaxed font-heading">
                                "${escapeHtml(src)}"
                            </p>
                        </blockquote>
                    </div>
                `;
            }
            
            return container;
        }
        
        // Load schedule, FAQs, and story when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadSchedule();
            loadFAQs();
            loadStory();
        });
    </script>
</body>
</html>
